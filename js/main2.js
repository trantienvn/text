var isChromeApp=function(){return!("chrome"!==getBrowser()||!chrome||!chrome.storage)},getBrowser=function(){var e=window.navigator.userAgent.toLowerCase(),t=window.navigator.appVersion.toLowerCase(),o="unknown";return-1!=e.indexOf("msie")?o=-1!=t.indexOf("msie 6.")?"ie6":-1!=t.indexOf("msie 7.")?"ie7":-1!=t.indexOf("msie 8.")?"ie8":-1!=t.indexOf("msie 9.")?"ie9":-1!=t.indexOf("msie 10.")?"ie10":"ie":-1!=e.indexOf("trident/7")?o="ie11":-1!=e.indexOf("chrome")?o="chrome":-1!=e.indexOf("safari")?o="safari":-1!=e.indexOf("opera")?o="opera":-1!=e.indexOf("firefox")&&(o="firefox"),o},menuVisibility=!0,loginStatus=!1,editorFocused=!0,findController=new FindControl,PADDING_FULLSCREEN=isChromeApp()?30:10;navigator.userAgent.indexOf("Chrome")<0&&(chrome=null);var pushGAQ=function(e){!1===isChromeApp()&&_gaq.push(e)};if(!1===isChromeApp()){var _gaq=_gaq||[];pushGAQ(["_setAccount","UA-27635130-2"]),pushGAQ(["_trackPageview"]),function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://ssl.google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()}$(document).ready((function(){layout(),$(window).resize((function(){layout()})),$(".pulldown").pulldown("right"),$(".font-family-menu").each((function(e,t){$(this).css("font-family",$(this).text())})),$(".font-size-menu").each((function(e,t){$(this).css("font-size",$(this).text())})),$(".toggle").on("click",(function(){$(this).toggleClass("checked"),!0===$(this).children("input").prop("checked")?$(this).children("input").prop("checked",!1).change():$(this).children("input").prop("checked",!0).change()})),$(".shortcuts").keyup((function(e){shortcuts.set($(this).attr("data-action"),$(this).val().toUpperCase())})),settingsModel.load(),shortcuts.resume(),findController.init(),isChromeApp()?$g("sessionKey",(function(e){api2.setSessionKey(e),account((function(){startApp(),layout()}))})):account((function(){startApp(),layout()})),$(window).keyup((function(e){27===e.keyCode&&isPreviewMode()&&(hidePreview(),e.preventDefault())})),$(window).keydown((function(e){var t;if(editorFocused)if(e.ctrlKey||e.metaKey&&!e.ctrlKey){if(!e.altKey)if(e.shiftKey){if((t=String.fromCharCode(e.keyCode).toUpperCase())===shortcuts.keys.preview)!1===isPreviewMode()?previewMarkdown():hidePreview(),e.preventDefault();else if(t===shortcuts.keys.statistics){var o="show"===settingsModel.showStatistics;settingsModel.setShowStatistics(!o),e.preventDefault()}}else(t=String.fromCharCode(e.keyCode).toUpperCase())===shortcuts.keys.sync?(sync(),e.preventDefault()):t===shortcuts.keys.format_bold?(wrap("**"),e.preventDefault()):t===shortcuts.keys.format_italic?(wrap("*"),e.preventDefault()):t===shortcuts.keys.format_list?(insertTopOfLine("* "),e.preventDefault()):t===shortcuts.keys.format_link?(insertLinkFormat(),e.preventDefault()):t===shortcuts.keys.find&&!0===isChromeApp()?(findController.toggleFindMode(),e.preventDefault()):"P"===t&&!0===isChromeApp()?(window.print(),e.preventDefault()):13===e.keyCode&&(toggleFullscreenMode(),e.preventDefault())}else if(9===e.keyCode&&!e.altKey&&!e.ctrlKey&&!e.metaKey){var i="    ";e.shiftKey?deleteTopOfLine(i):insertTopOfLine(i),e.preventDefault()}27===e.keyCode&&e.preventDefault()})),$("textarea#editor").keyup((function(e){var t=textStorage.getContents(),o=getEditorValue();if(textStorage.setContents(o),t!==o){var i=WriteboxFileStatus.get();i.file.edit=!0,updateFileStatus(i),!0===menuVisibility&&($("#menu, #header, .slidedown-bar").animate({opacity:0},2e3),menuVisibility=!1)}})),document.onselectionchange=function(){updateStatisticsInfo()},$("#menu, #header").hover((function(){$("#menu, #header, .slidedown-bar").animate({opacity:1},100),menuVisibility=!0})),$("#new-button").click((function(){newText(),$("textarea#editor").focus()})),$("#load-button").click((function(){chooser.build("#chooser-dialog","open",loadCloudFile,confirmMoveToAuthProcess),showDialog({dialogId:"#chooser-dialog"}),$("#file-name-input").focus()})),$("#sync-button").click((function(){sync(),pushGAQ(["_trackEvent","sync-button","clicked"])})),$("#print-button").click((function(){window.print()})),$("#fullscreen-button").click((function(){toggleFullscreenMode()})),$("#find-button").click((function(){findController.toggleFindMode()})),$("#find-next-button").click((function(){findController.findNext()})),$("#find-prev-button").click((function(){findController.findPrevious()})),$("#copy-html-menu").click((function(){})),$("#preview-markdown-button, #preview-markdown-menu").click((function(){isPreviewMode()?hidePreview():previewMarkdown()})),$("#preview-markdown-esc-message").click((function(){hidePreview()})),$("#discard-button").click((function(){"local"===WriteboxFileStatus.get().storage.name?showDialog({dialogId:"#confirm-discard-text-dialog",okay:function(){createEmptyText()},cancel:function(){}}):showDialog({dialogId:"#confirm-delete-cloud-file-dialog",okay:function(){deleteCloudFile(WriteboxFileStatus.get(),(function(){createEmptyText()}))},cancel:function(){}})})),$("#delete-local-data-button").click((function(){showDialog({dialogId:"#confirm-clear-local-data-dialog",okay:function(){$clear(),setEditorValue("");var e=WriteboxFileInfo.createLocalFile();updateFileStatus(e),updateStatisticsInfo(),buildRecentListMenu()},cancel:function(){}})})),$("#saveas-button").click((function(){var e=WriteboxFileStatus.get().file.mimeType;selectCloudFile((function(t){if(""!==t.file.name){t.file.mimeType=e,hideDialog();var o=getEditorValue();saveFileContents(t,o),updateFileStatus(t)}else hideDialog()}))})),$("#move-button").click((function(){selectCloudFolder((function(e){hideDialog(),moveCloudFile(WriteboxFileStatus.get(),e)}))})),$("#download-text-menu").click((function(){var e=getEditorValue(),t=WriteboxFileStatus.get();downloadFile(t.file.name,e,"text/plain")})),$("#download-markdown-menu").click((function(){var e=getEditorValue(),t=WriteboxFileStatus.get();downloadFile(t.file.name,e,"text/markdown")})),$("#download-html-menu").click((function(){var e=getEditorValue(),t=WriteboxFileStatus.get(),o=t.file.name.split("."),i="";o.length>0?(i=t.file.name.replace("."+o[o.length-1],".html"),title=t.file.name.replace("."+o[o.length-1],"")):(i=t.file.name,title=i);var n=$.ajax({url:"/static/template/template.html",async:!1}).responseText.replace("{{title}}",title).replace("{{contents}}",marked(e)).replace("{{color}}",settingsModel.textColor).replace("{{backgroundColor}}",settingsModel.backgroundColor).replace("{{fontFamily}}",settingsModel.fontFamily);downloadFile(i,n,"text/html")})),$("#about-button").click((function(){window.open("http://writeboxapps.com/","_blank")})),$("#follow-button").click((function(){window.open("https://twitter.com/shibuyak25","_blank")})),$("#option-button").click((function(){toggleSidebar("#option-bar")})),$("#shortcuts-setting-button").click((function(){for(k in shortcuts.keys)$(".shortcuts[data-action="+k+"]").val(shortcuts.keys[k]);toggleSidebar("#shortcuts-dialog")})),$(".shortcuts").keyup((function(e){})),$("#restore-default-shortcuts").click((function(){shortcuts.restoreDefault()})),$(".slidedown-bar .close-button").click((function(){hideSlidedownBar(".slidedown-bar")})),$(".side-bar .close-button").click((function(){toggleSidebar("#"+$(this).parent().attr("id"))})),$(".font-size-menu").click((function(){var e=$(this).text();settingsModel.setFontSize(e),layout()})),$(".font-family-menu").click((function(){var e=$(this).text();""!==e&&(settingsModel.setFontFamily(e),layout())})),$("#custom-font-family").keypress((function(e){if(13===e.keyCode){var t=$(this).val();""!==t&&(settingsModel.setFontFamily(t),layout(),$(this).parent().parent().hide(),$(this).val(""),$(this).parent().parent().parent().children(".label").removeClass("selected"),$(".pulldown-bg-layer").remove())}})),$("#current-width").keypress((function(e){if(13===e.keyCode){var t=$(this).val();settingsModel.setWidth(t)}})),$("#current-line-height").keypress((function(e){if(13===e.keyCode){var t=$(this).val();settingsModel.setLineHeight(t)}})),$("#current-show-statics").change((function(){var e=$(this).prop("checked");settingsModel.setShowStatistics(e)})),$("#current-show-scrollbar").change((function(){var e=$(this).prop("checked");settingsModel.setShowScrollbar(e)})),$("#okcancel-dialog-disable").change((function(){var e=$(this).attr("checked");settingsModel.setPromptBeforeDiscarding(e)})),$("#link-dropbox-button").click((function(){linkCloudService("dropbox")})),$("#link-googledrive-button").click((function(){linkCloudService("googledrive")})),$("#unlink-dropbox-button").click((function(){unlinkCloudService("dropbox",(function(){account()}))})),$("#unlink-googledrive-button").click((function(){unlinkCloudService("googledrive",(function(){account()}))})),$("#link-box-button").click((function(){linkCloudService("box")})),$("#link-onedrive-button").click((function(){linkCloudService("onedrive")})),$("#unlink-box-button").click((function(){unlinkCloudService("box",(function(){account()}))})),$("#unlink-onedrive-button").click((function(){unlinkCloudService("onedrive",(function(){account()}))})),$("#download-latest-button").click((function(){hideSlidedownBar("#message-bar");var e=WriteboxFileStatus.get();loadCloudFile(e)})),$("#bg-color-picker").simpleColorPicker({onChangeColor:function(e){settingsModel.setBackgroundColor(e)}}),$("#front-color-picker").simpleColorPicker({onChangeColor:function(e){settingsModel.setTextColor(e)}}),$("#filename span").focus((function(){$(this).css("color","#4d90fe")})),$("#filename span").blur((function(){var e=$("#filename span").text(),t=WriteboxFileStatus.get();e!==t.file.name&&renameCloudFile(t,e)})),$("#filename span").keydown((function(e){13===e.keyCode&&($(this).blur(),e.preventDefault())}));var e=null;$("#toggle-maximize-button").click((function(){chrome.app&&(chrome.app.window.current().isMaximized()&&null!==e?chrome.app.window.current().setBounds(e):(e=chrome.app.window.current().getBounds(),chrome.app.window.current().maximize()))})),window.matchMedia("print").addListener((function(e){if(e.matches)if($("#print-window").show(),$("#preview *").css("font-family",settingsModel.fontFamily).css("color",settingsModel.textColor),!0===isPreviewMode()){var t=$("#preview > div").html();$("#print-window > .contents").html(t)}else{for(var o="",i=getEditorValue().split("\n"),n=0;n<i.length;n++)o+=i[n]+"<br/>";$("#print-window > .contents").html(o)}else $("#print-window").hide()}))}));var startApp=function(){0===window.location.href.indexOf("chrome")||($(".test").hide(),$("#filename > span").attr("contenteditable","true")),navigator.userAgent.indexOf("Chrome")>0||navigator.userAgent.indexOf("Safari")>0?$("#current-show-scrollbar").parent().show():$("#current-show-scrollbar").parent().hide(),$("body").addClass("chrome-app"),isChromeApp()?($("#download-text-menu").hide(),$("#download-html-menu").hide(),$("#window-close-button").click((function(){chrome.app.window.current().close()}))):($("#print-button").hide(),$("#fullscreen-button").hide(),$("#find-button").hide(),$("#find-button").next().hide()),$("#header").css("visibility","visible"),WriteboxFileStatus.load((function(e){updateFileStatus(e),""!==e.storage.name&&"local"!==e.storage.name&&getModifiedDate(e,(function(t){t&&(t>new Date(Date.parse(e.file.modified))&&showSlidedownBar("#message-bar"))}))})),layout(),textStorage.resume((function(){var e=textStorage.getContents();""!==e&&(setEditorValue(e),updateStatisticsInfo())})),$("textarea#editor").focus(),buildRecentListMenu();var e=$("#writebox-info-dialog").attr("attr-infoid");""!==e&&$g("infoid",(function(t){e!==t&&showDialog({dialogId:"#writebox-info-dialog",closed:function(){$s("infoid",e)}})}))},layout=function(){var e=0,t=0;$g("width",(function(o){o=parseInt(o)||800,$(window).width()<800+PADDING_FULLSCREEN?o<$(window).width()?(e=o,t=$(window).width()/2-e/2+PADDING_FULLSCREEN):(e=$(window).width()-2*PADDING_FULLSCREEN,t=PADDING_FULLSCREEN):(e=o,t=$(window).width()/2-e/2),$("#editor").css("margin-left",t).css("padding-right",t).width(e+t),$("#editor > div.contents").height($("#eidtor").height()-10);var i=$("#editor").position().top;$("#markdown-preview-window").css("position","absolute").css("top",i).css("left",$("#editor").position().left+t).css("width",$("#editor").width()+t).css("height",$(window).height()-i),$("#preview").css("padding-right",t).css("overflow-x","hidden").css("height",$(window).height()-i),findController.layoutEditorHighlightArea(),layoutLinkWindow()}))},layoutLinkWindow=function(){var e=$(window).width()-100,t=$(window).height()-40;$("#link-window").css("width",e).css("height",t).css("top",20).css("left",50),$("#link-window > webview").css("height",t-$("#link-window > webview").position().top)},showDialog=function(e){var t=function(){$(e.dialogId+" .close-button").unbind("click"),$(e.dialogId+" .cancel-button").unbind("click"),$(e.dialogId+" .okay-button").unbind("click")};$(e.dialogId+" .dialog-close-button").click((function(){t(),$(e.dialogId).hide(),e.closed&&e.closed()})),$(e.dialogId+" .cancel-button").click((function(){t(),$(e.dialogId).hide(),e.cancel&&e.cancel()})),$(e.dialogId+" .okay-button").click((function(){t(),$(e.dialogId).hide(),e.okay&&e.okay()})),$(e.dialogId).show(),e.open&&e.open()},hideDialog=function(e){e?($(e).prev(".dialog-bg").remove(),$(e).hide()):($(".dialog-bg").remove(),$(".dialog").hide())},showProcessingMessage=function(e,t){$("#processing-message").css("position","absolute").css("bottom",-30).show(),$("#processing-message").animate({bottom:0},500),$("#processing-message").text(e),$("#processing-message").addClass(t)},hideProcessingMessage=function(e){setTimeout((function(){$("#processing-message").animate({bottom:-30},500,(function(){$("#processing-message").text(""),$("#processing-message").removeClass(e),$("#processing-message").hide()}))}),2e3)},createEmptyText=function(){var e=WriteboxFileInfo.createLocalFile();updateFileStatus(e),setEditorValue(""),$s("contents",""),updateStatisticsInfo(),$("#discard-button").addClass("disable")},saveCurrentFileOnLocal=function(e){var t=WriteboxFileStatus.get(),o=textStorage.getContents();WriteboxLocalFileManagement.saveFile(t,o,(function(t){showProcessingMessage("File saved locally.","processing"),hideProcessingMessage("processing"),e(t)}))},newText=function(){isCurrentFileEditing()?saveCurrentFileOnLocal((function(e){e&&createEmptyText()})):createEmptyText()},isCurrentFileEditing=function(){return WriteboxFileStatus.get().file.edit},updateFileStatus=function(e){switch(console.log("==updateFileStatus() has called.=="),console.log(e),$("#filename span").text(e.file.name),"local"===e.storage.name?$("#filename span").attr("contenteditable",!1):$("#filename span").attr("contenteditable",!0),e.storage.name){case"dropbox":$("#filename img").attr("src","/static/image/storage/dropbox_icon.png"),$("#filename img").addClass("show");break;case"googledrive":$("#filename img").attr("src","/static/image/storage/drive_icon.png"),$("#filename img").addClass("show");break;case"box":$("#filename img").attr("src","/static/image/storage/box_icon.png"),$("#filename img").addClass("show");break;case"onedrive":$("#filename img").attr("src","/static/image/storage/onedrive_icon.png"),$("#filename img").addClass("show");break;default:$("#filename img").attr("src",""),$("#filename img").removeClass("show")}WriteboxFileStatus.save(e)},loadCloudFile=function(e){var t=getEditorValue();hideDialog(),setEditorValue("Loading...");var o,i=api2[e.storage.name];o="dropbox"===e.storage.name?e.parent.path+"/"+e.file.name:e.file.id,i.getTextData({query:o,success:function(o,i,n){var r=function(e,t){e.file.mimeType=n,e.file.modified=i,updateFileStatus(e),setEditorValue(t),textStorage.setContents(t),WriteboxRecentFileList.push(e,(function(){buildRecentListMenu()})),updateStatisticsInfo()};isCurrentFileEditing()?saveCurrentFileOnLocal((function(i){i?r(e,o):setEditorValue(t)})):r(e,o)},error:function(){setEditorValue(t),showDialog({dialogId:"#error-load-dialog"})}})},deleteCloudFile=function(e,t){var o=getEditorValue();hideDialog(),setEditorValue("Deleting...");var i=api2[e.storage.name],n=e.file.id;i.deleteFile({query:n,success:function(){t()},error:function(){setEditorValue(o),showDialog({dialogId:"#error-delete-dialog"})}})},renameCloudFile=function(e,t){showProcessingMessage("Changing...","processing");var o=t;"dropbox"===e.storage.name&&(o="/"===e.parent.path?"/"+t:e.parent.path+"/"+t),api2[e.storage.name].renameFile({query:e.file.id,fileName:o,success:function(i){if(hideProcessingMessage(),e.file.id=i.fileID,e.file.name=t,"dropbox"===e.storage.name){var n=o.substring("/"+t,"");""===n&&(n="/"),e.parent.path=n}e.file.modified=i.modified,updateFileStatus(e)},error:function(){showDialog({dialogId:"#error-rename-dialog"}),hideProcessingMessage(),updateFileStatus(e)}})},moveCloudFile=function(e,t){showProcessingMessage("Moving...","processing");var o=t.id;"dropbox"===t.storageName&&(o=t.path+e.file.name),api2[t.storageName].moveFile({query:e.file.id,destination:o,success:function(i){hideProcessingMessage(),"dropbox"===t.storageName&&(e.file.id=o),e.parent.id=t.id,e.parent.name=t.name,e.parent.path=t.path,e.storage.name=t.storageName,updateFileStatus(e)},error:function(){showDialog({dialogId:"#error-rename-dialog"}),hideProcessingMessage(),updateFileStatus(e)}})},selectCloudFile=function(e){chooser.build("#chooser-dialog","save",e,confirmMoveToAuthProcess),showDialog({dialogId:"#chooser-dialog"}),$("#file-name-input").focus()},selectCloudFolder=function(e){chooser.build("#chooser-dialog","choose-folder",e,confirmMoveToAuthProcess),showDialog({dialogId:"#chooser-dialog"})},sync=function(){console.log("==== sync() has called ====");var e=WriteboxFileStatus.get();if(""!==e.file.name){var t=getEditorValue();saveFileContents(e,t)}else selectCloudFile((function(e){if(""!==e.file.name){hideDialog();var t=getEditorValue();saveFileContents(e,t),updateFileStatus(e)}else hideDialog()}))},isPreviewMode=function(){return"none"!==$("#markdown-preview-window").css("display")},hidePreview=function(){$("#markdown-preview-window").fadeOut(300,(function(){$("#markdown-preview-window").removeClass("preview-status-on")})),$("#preview-markdown-esc-message").fadeOut(300,(function(){$("#header > div#menu").fadeIn(200)})),$("#editor").animate({opacity:1,duration:300})},previewMarkdown=function(){var e=marked(getEditorValue());$("#preview > div").html(e),$("#markdown-preview-window, #preview").css("background",settingsModel.backgroundColor),$("#preview *").css("font-family",settingsModel.fontFamily).css("color",settingsModel.textColor),$("#markdown-preview-window").addClass("preview-status-on"),$("#editor").animate({opacity:0,duration:300},(function(){$("#markdown-preview-window").fadeIn(200),$("#preview-markdown-esc-message").fadeIn(200)})),$("#header > div#menu").fadeOut(300),$("#editor").blur()},getSelectionStringLen=function(){var e=document.getElementById("editor"),t=e.selectionStart;return e.selectionEnd-t},wrap=function(e,t){var o=document.getElementById("editor"),i=o.value,n=o.selectionStart,r=o.selectionEnd,a=r-n;t=t||e,n!==r?(o.value=i.substring(0,n)+e+i.substring(n,r)+t+i.substring(r,o.value.length),o.selectionStart=n+token.length,o.selectionEnd=o.selectionStart+a):(o.value=i.substring(0,n)+e+t+i.substring(r,o.value.length),o.selectionStart=n+e.length,o.selectionEnd=o.selectionStart)},insertTopOfLine=function(e){var t,o,i,n,r,a=document.getElementById("editor"),s=a.value,l=a.selectionStart,c=a.selectionEnd,d=c-l-1,u=(t=s.substr(0,l)).lastIndexOf("\n");u>0&&(d=c-(l=u+1)-1,t=s.substr(0,l)),o=d>0?e+s.substr(l,d).split("\n").join("\n"+e)+s.substr(c-1,1):e,i=s.substr(c,s.length),a.value=t+o+i,r=d>0?(n=l)+o.length:n=e.length+l,a.setSelectionRange(n,r)},insertLinkFormat=function(){var e,t,o,i,n=document.getElementById("editor"),r=n.value,a=n.selectionStart,s=n.selectionEnd,l=s-a;e=r.substr(0,a),t=r.substr(a,l),o=r.substr(s,r.length-s),n.value=e+"["+t+"]()"+o,i=l>0?s+3:s+1,n.setSelectionRange(i,i)},getSelectedEditorValue=function(){var e=document.getElementById("editor"),t=e.value,o=e.selectionStart,i=e.selectionEnd;return t.substr(o,i-o)},deleteTopOfLine=function(e){var t,o,i,n,r,a=document.getElementById("editor"),s=a.value,l=a.selectionStart,c=a.selectionEnd;c-l>0&&(t=s.substr(0,l),(o=s.substr(l,c-l).split("\n"+e).join("\n")).substr(0,e.length)===e&&(o=o.replace(e,"")),i=s.substr(c,s.length),a.value=t+o+i,r=(n=l)+o.length,a.setSelectionRange(n,r))},saveFileContents=function(e,t){var o=e;console.log("==saveFileContents() has called.=="),console.log(o),showProcessingMessage("Saving...","processing");var i=api2[o.storage.name],n="";n="dropbox"===o.storage.name?o.parent.path+"/"+o.file.name:o.file.id;var r=o.file.mimeType;void 0===r&&(r="text/plain"),i.saveTextData({fileID:n,fileName:o.file.name,mimeType:r,parentFolderID:o.parent.id,contents:t,success:function(e,i){hideProcessingMessage("processing"),$("#discard-button").addClass("disable"),console.log(o),o.file.id=e,o.file.modified=i,o.file.edit=!1,updateFileStatus(o),textStorage.setContents(t)},error:function(){hideProcessingMessage("processing"),showDialog({dialogId:"#error-save-dialog"})}})},account=function(e){api2.getAccount({success:function(t){0===t.linked_count?($("#dropbox-account").text(""),$("#link-dropbox-button").show(),$("#unlink-dropbox-button").hide(),$("#googledrive-account").text(""),$("#link-googledrive-button").show(),$("#unlink-googledrive-button").hide(),$("#box-account").text(""),$("#link-box-button").show(),$("#unlink-box-button").hide(),$("#onedrive-account").text(""),$("#link-onedrive-button").show(),$("#unlink-onedrive-button").hide(),loginStatus=!1):(t.dropbox?($("#dropbox-account").text(t.dropbox.mail_address),$("#link-dropbox-button").hide(),$("#unlink-dropbox-button").show()):($("#dropbox-account").text(""),$("#link-dropbox-button").show(),$("#unlink-dropbox-button").hide()),t.googledrive?($("#googledrive-account").text(t.googledrive.mail_address),$("#link-googledrive-button").hide(),$("#unlink-googledrive-button").show()):($("#googledrive-account").text(""),$("#link-googledrive-button").show(),$("#unlink-googledrive-button").hide()),t.box?($("#box-account").text(t.box.mail_address),$("#link-box-button").hide(),$("#unlink-box-button").show()):($("#box-account").text(""),$("#link-box-button").show(),$("#unlink-box-button").hide()),t.onedrive?($("#onedrive-account").text(t.onedrive.mail_address),$("#link-onedrive-button").hide(),$("#unlink-onedrive-button").show()):($("#onedrive-account").text(""),$("#link-onedrive-button").show(),$("#unlink-onedrive-button").hide()),loginStatus=!0),e&&e()},error:function(){$("#dropbox-account").text(""),$("#link-dropbox-button").show(),$("#unlink-dropbox-button").hide(),$("#googledrive-account").text(""),$("#link-googledrive-button").show(),$("#unlink-googledrive-button").hide(),loginStatus=!1,e&&e()}})},getModifiedDate=function(e,t){var o;o="dropbox"===e.storage.name?e.parent.path+"/"+e.file.name:e.file.id,api2[e.storage.name].getMetaData({query:o,success:function(e){var o=new Date(Date.parse(e.modified));t(o)},error:function(){t(null)}})},login=function(){api.login()},linkCloudService=function(e){if(!0===isChromeApp()){editorFocused=!1;var t=api2[e].getLinkUrl(),o=document.querySelector("#link-window > webview");o.addEventListener("loadstart",(function(e){$("#link-window-header > .message").text("Loading...")})),o.addEventListener("loadstop",(function(e){$("#link-window-header .message").text("")})),o.addEventListener("loadredirect",(function(e){if($("#link-window-header .message").text("Loading..."),0===e.newUrl.indexOf(api2.host+"/key")){var t=e.newUrl.replace(api2.host+"/key?returnkey=","");t&&($s("sessionKey",t),api2.setSessionKey(t)),$("#link-window").hide(),account(),editorFocused=!0}})),$("#link-window > webview").attr("src",t),$("#link-window .cancel-button").click((function(){$("#link-window").hide(),editorFocused=!0})),$("#link-window").show(),layoutLinkWindow()}else if(0===window.location.href.indexOf("chrome")){api2[e].linkWithNewTab((function(){account()}))}else{api2[e].link()}},unlinkCloudService=function(e,t){var o=api2[e];showProcessingMessage("Unlinking...","processing"),o.unlink({success:function(){setTimeout((function(){t(),hideProcessingMessage()}),3e3)},error:function(){hideProcessingMessage()}})},logout=function(){api.logout({success:function(){$("#account-menu").hide(),$("#login-button").show(),$("#sync-button").addClass("disable"),layout(),loginStatus=!1},error:function(){}})},toggleSidebar=function(e){$(e).hasClass("on")?($(e).removeClass("on"),$(e).animate({right:-$(e).width()},200,(function(){$(e).css("visibility","hidden").addClass("off")}))):($(e).removeClass("off"),$(e).css("visibility","visible"),$(e).animate({right:0},200,(function(){$(e).addClass("on")})))},toggleSlidedownBar=function(e){$(e).slideToggle(300,(function(){$(e).show()}))},showSlidedownBar=function(e){$(e).slideDown(150)},hideSlidedownBar=function(e){$(e).slideUp(150)},toggleFullscreenMode=function(){chrome.app.window.current().isFullscreen()?chrome.app.window.current().restore():chrome.app.window.current().fullscreen()},getServiceName=function(e){switch(e){case"dropbox":return"Dropbox";case"googledrive":return"Google Drive";case"box":return"Box";case"onedrive":return"OneDrive"}},confirmMoveToAuthProcess=function(e){var t=getServiceName(e);$("#confirm-move-to-authorize-process .title").text("Link "+t+" Account"),showDialog({dialogId:"#confirm-move-to-authorize-process",okay:function(){linkCloudService(e)},cancel:function(){}})},settingsModel={fontSize:"",fontFamily:"",backgroundColor:"",textColor:"",width:"",lineHeight:"",showStatistics:"",showScrollbar:"",setFontSize:function(e){this.fontSize=e,$s("fontSize",e),$("#current-font-size").text(e),$("#editor").css("font-size",e)},setFontFamily:function(e){this.fontFamily=e,$s("fontFamily",e),$("#current-font-family").text(e),$("#editor").css("font-family",e)},setWidth:function(e){this.width=e,$s("width",e),$("#current-width").val(e),layout()},setLineHeight:function(e){this.lineHeight=e,$s("lineHeight",e),$("#current-line-height").val(e),$("#editor").css("lineHeight",e+"em")},setShowStatistics:function(e){e?(this.showStatistics="show",$s("showStatics","show"),$("#current-show-statics").parent().addClass("checked"),$("#current-show-statics").prop("checked",!0),$("#document-statistics").show()):(this.showStatistics="hide",$s("showStatics","hide"),$("#current-show-statics").parent().removeClass("checked"),$("#current-show-statics").prop("checked",!1),$("#document-statistics").hide())},setShowScrollbar:function(e){e?(this.showScrollbar="show",$s("showScrollbar","show"),$("#current-show-scrollbar").parent().addClass("checked"),$("#current-show-scrollbar").prop("checked",!0),$("#editor, #preview").removeClass("off-scrollbar")):(this.showScrollbar="hide",$s("showScrollbar","hide"),$("#current-show-scrollbar").parent().removeClass("checked"),$("#current-show-scrollbar").prop("checked",!1),$("#editor, #preview").addClass("off-scrollbar")),layout()},setBackgroundColor:function(e){this.backgroundColor=e,$s("backgroundColor",e),$("#bg-color-picker").css("background-color",e),$("body").css("background-color",e)},setTextColor:function(e){this.textColor=e,$s("textColor",e),$("#front-color-picker").css("background-color",e),$("#editor, #editor-footer").css("color",e)},load:function(){var e=this;$g("fontSize",(function(t){void 0!==t&&""!==t&&e.setFontSize(t)})),$g("fontFamily",(function(t){void 0!==t&&""!==t&&e.setFontFamily(t)})),$g("width",(function(t){void 0!==t&&""!==t&&e.setWidth(t)})),$g("lineHeight",(function(t){void 0!==t&&""!==t&&e.setLineHeight(t)})),$g("backgroundColor",(function(t){void 0!==t&&""!==t&&e.setBackgroundColor(t)})),$g("textColor",(function(t){void 0!==t&&""!==t&&e.setTextColor(t)})),$g("showStatics",(function(t){if(void 0!==t&&""!==t){var o="show"===t;e.setShowStatistics(o)}})),$g("showScrollbar",(function(t){if(void 0!==t&&""!==t){var o="show"===t;e.setShowScrollbar(o)}}))}},textStorage={contents:"",resume:function(e){var t=this;$g("contents",(function(o){t.contents=o,e()}))},setContents:function(e){this.contents=e,$s("contents",e)},getContents:function(){return this.contents}},shortcuts={defaultKeys:{sync:"S",preview:"P",format_bold:"B",format_italic:"I",format_list:"L",format_link:"K",find:"F",statistics:"K"},keys:{sync:"S",preview:"P",format_bold:"B",format_italic:"I",format_list:"L",format_link:"K",find:"F",statistics:"K"},resume:function(){$g("shortcuts",(function(e){if(e){var t=JSON.parse(e);for(k in t)shortcuts.keys[k]=t[k];for(k in shortcuts.keys)$(".shortcuts[data-action="+k+"]").val(shortcuts.keys[k])}}))},set:function(e,t){shortcuts.keys[e]=t,$s("shortcuts",JSON.stringify(shortcuts.keys))},restoreDefault:function(){$s("shortcuts",JSON.stringify(shortcuts.defaultKeys)),shortcuts.resume()}},loadLocalFile=function(e){WriteboxLocalFileManagement.getFile(e,(function(e){isCurrentFileEditing()&&saveCurrentFileOnLocal((function(e){})),updateFileStatus(e.wbFileInfo),setEditorValue(e.contents),$("textarea#editor").focus(),textStorage.setContents(e.contents),$("#discard-button").removeClass("disable"),updateStatisticsInfo()}))},buildRecentListMenu=function(){var e=$("#recent-button").children("ul");$(e).empty(),WriteboxRecentFileList.getAll((function(t){for(var o=t.length-1;o>=0;o-=1){var i=t[o],n=document.createElement("li"),r=document.createElement("img"),a=document.createElement("div"),s=document.createElement("div");"dropbox"===i.storage.name?$(r).attr("src","/static/image/storage/dropbox_icon.png"):"googledrive"===i.storage.name?$(r).attr("src","/static/image/storage/drive_icon.png"):"box"===i.storage.name?$(r).attr("src","/static/image/storage/box_icon.png"):"onedrive"===i.storage.name&&$(r).attr("src","/static/image/storage/onedrive_icon.png"),$(r).addClass("storage-icon"),$(s).addClass("recent-title").append(i.file.name);"dropbox"===i.storage.name?i.parent.path+"/"+i.file.name:"googledrive"===i.storage.name&&i.file.name,$(a).addClass("recent-item").attr("data-index",o).append(r).append(s),$(a).click((function(){$(".pulldown-bg-layer").remove(),$(this).parent().parent().toggle();var e=$(this).attr("data-index"),o=t[e];loadCloudFile(o)})),$(n).append(a),$(e).append(n)}t.length>0?$("#recent-button").removeClass("disable"):$("#recent-button").addClass("disable")}))},toThreeDigit=function(e){var t=[],o=e.toString().split("").reverse(),i=o.length;return o.forEach((function(e,o){t.push(e),(o+1)%3==0&&o!==i-1&&"-"!==e&&t.push(",")})),t.reverse().join("")},updateStatisticsInfo=function(){var e=getEditorValue();if(getSelectionStringLen()>0){$("#document-statistics > .normal").hide(),$("#document-statistics > .selected").show();var t=getSelectedEditorValue(),o=t.split(/\S+/g).length-1,i=t.replace(/\n/g,"").length;$("#selected-word-count").text(toThreeDigit(o)),$("#selected-char-count").text(toThreeDigit(i))}else if($("#document-statistics > .normal").show(),$("#document-statistics > .selected").hide(),""!==e){var n=e.length,r=e.split(/\S+/g).length-1,a=e.replace(/\n/g,"").length,s=n-a+1;$("#line-count").text(toThreeDigit(s)),$("#word-count").text(toThreeDigit(r)),$("#char-count").text(toThreeDigit(a))}else $("#line-count").text("-"),$("#word-count").text("-"),$("#char-count").text("-")},showLocalStorageErrorDialog=function(e){var t="#error-localstorage-dialog";e?$(t).find(".okay-button").show():$(t).find(".okay-button").hide(),showDialog({dialogId:t,okay:function(){createEmptyText()},cancel:function(){}})},$g=function(e,t){t&&(chrome&&chrome.storage?chrome.storage.local.get(e,(function(o){t(o[e])})):t(localStorage[e]))},$s=function(e,t,o){if(chrome&&chrome.storage){var i={};i[e]=t,chrome.storage.local.set(i,(function(){o&&o()}))}else try{localStorage.setItem(e,t)}catch(e){showLocalStorageErrorDialog(!1)}},$clear=function(){chrome&&chrome.storage?chrome.storage.local.clear():localStorage.clear()},WriteboxChooser={},chooser=WriteboxChooser;WriteboxChooser.build=function(e,t,o,i){var n=this;n.dialogID=e,n.feature=t,n.selectedCallback=o,n.authorizeErrorCallback=i,n.currentStorage="local",n.currentFile={dropbox:{id:"/",name:"Dropbox"},googledrive:{id:"root",name:"Google Drive"},onedrive:{id:"root",name:"OneDrive"},box:{id:"/",name:"Box"}},n.currentFolderNavList={dropbox:[],googledrive:[],onedrive:[],box:[]},n._emptyFileList("dropbox"),n._emptyFileList("googledrive"),n._emptyFileList("onedrive"),n._emptyFileList("box"),n._buildEventHandler(),n._loadChooserStatus((function(){var e="";if("open"===t)n.buildOpenUI(),e=n.currentStorage;else if("choose-folder"===t){if(n.buildChooseFolderUI(),"local"===n.currentStorage)e="local"!==(o=WriteboxFileStatus.get()).storage.name&&""!==o.storage.name?o.storage.name:"dropbox";else e=n.currentStorage}else if("save"===t){var o;if(n.buildSaveUI(),"local"===n.currentStorage)e="local"!==(o=WriteboxFileStatus.get()).storage.name&&""!==o.storage.name?o.storage.name:"dropbox";else e=n.currentStorage}n._switchStorage(e),n._updateLocalFileCount()}))},WriteboxChooser._saveChooserStatus=function(){$s("chooser",JSON.stringify({storage:this.currentStorage,file:this.currentFile,folderNavList:this.currentFolderNavList}))},WriteboxChooser._loadChooserStatus=function(e){var t=this;$g("chooser",(function(o){o&&(o=JSON.parse(o),t.currentStorage=o.storage,t.currentFile=o.file,t.currentFolderNavList=o.folderNavList),e()}))},WriteboxChooser.deleteChooserStatus=function(){$s("chooser",JSON.stringify({storage:"local",file:{id:"",name:""},folderNavList:[]}))},WriteboxChooser._buildEventHandler=function(){var e=this;$(e.dialogID+" .chooser-storagelist").unbind(),$(e.dialogID+" .chooser-storagelist").click((function(){var t=$(this).attr("data-storage");e._switchStorage(t)}))},WriteboxChooser._switchStorage=function(e){if(this.currentStorage=e,$(this.dialogID+" .chooser-filelist").hide(),$(this.dialogID+" .chooser-filelist[data-storage="+this.currentStorage+"]").show(),$(this.dialogID+" .chooser-storagelist").removeClass("selection"),$(this.dialogID+" .chooser-storagelist[data-storage="+this.currentStorage+"]").addClass("selection"),"local"!==e)if(0===$(this.dialogID+" .chooser-filelist[data-storage="+this.currentStorage+"] li").size())this._choose(this.currentStorage,this.currentFile[this.currentStorage].id,this.currentFile[this.currentStorage].name);else{var t=this.currentFolderNavList[this.currentStorage];this._buildFileNavigatorUI(t)}else if("local"===e){var o=document.createElement("span");$(o).append("Local Cache"),$(this.dialogID+" .top-navigator").empty().append(o),this._buildLocalFileListUI(),this._saveChooserStatus()}},WriteboxChooser.buildOpenUI=function(){$("#chooser-dialog .title").text("Select text file.."),$("li[data-storage=local]").show(),$(".chooser-save-form").hide(),$("#chooser-dialog .bottombar").hide()},WriteboxChooser.buildSaveUI=function(){var e=this;$("#chooser-dialog .title").text("Save as.."),$("li[data-storage=local]").hide(),$(".chooser-save-form").show(),$(".chooser-save-form input").focus(),$("li[data-storage="+this.currentStorage+"]").click(),$("#chooser-save-button").text("Save"),$("#chooser-save-button").unbind("click"),$("#chooser-save-button").click((function(){var t=$(".chooser-save-form input").val(),o=e._getCurrentFolder(),i=WriteboxFileInfo.create(e.currentStorage,t,"",o.folderName,o.folderID,e._getCurrentFolderPath());e.selectedCallback(i)})),$(".chooser-save-form input").unbind("keypress"),$(".chooser-save-form input").keypress((function(t){if(13===t.keyCode){var o=$(".chooser-save-form input").val(),i=e._getCurrentFolder(),n=WriteboxFileInfo.create(e.currentStorage,o,"",i.folderName,i.folderID,e._getCurrentFolderPath());e.selectedCallback(n)}})),$("#chooser-dialog .bottombar").show()},WriteboxChooser.buildChooseFolderUI=function(){var e=this;$("#chooser-dialog .title").text("Choose.."),$("li[data-storage=local]").hide(),$(".chooser-save-form").show(),$(".chooser-save-form input").hide(),$("li[data-storage="+this.currentStorage+"]").click(),$("#chooser-save-button").text("Move"),$("#chooser-save-button").unbind("click"),$("#chooser-save-button").click((function(){var t=e._getCurrentFolder();e.selectedCallback({name:t.folderName,id:t.folderID,path:e._getCurrentFolderPath()+"/",storageName:e.currentStorage})})),$("#chooser-dialog .bottombar").show()},WriteboxChooser._emptyFileList=function(e){$(this.dialogID+" .chooser-filelist[data-storage="+e+"]").empty()},WriteboxChooser._showLoadingMessage=function(){var e=document.createElement("li");$(e).addClass("loading").text("Loading.."),$(this.dialogID+" .chooser-filelist[data-storage="+this.currentStorage+"]").append(e)},WriteboxChooser._addEmptyFolderMessage=function(){var e=document.createElement("li");$(e).text("No text file"),$(this.dialogID+" .chooser-filelist[data-storage="+this.currentStorage+"]").append(e)},WriteboxChooser._choose=function(e,t,o){var i=this;if("local"!==e){i._emptyFileList(e),i._showLoadingMessage();var n=i._addNavigator(t,o);i._buildFileNavigatorUI(n),api2[e].getFiles({query:t,success:function(n){i._buildCloudFileListUI(e,n),i.currentFile[e]={id:t,name:o},i._saveChooserStatus(),0===n.length&&i._addEmptyFolderMessage()},error:function(t){var o=$(i.dialogID+" .chooser-filelist[data-storage="+e+"]");$(o).empty();var n=document.createElement("li");$(o).append(n),401===t?($(n).text("Authorization error"),i.authorizeErrorCallback&&i.authorizeErrorCallback(e)):404===t?$(n).text("File path not found"):$(n).text("Load error")}})}},WriteboxChooser._buildCloudFileListUI=function(e,t){var o=this;o._emptyFileList(e);for(var i=$(this.dialogID+" .chooser-filelist[data-storage="+e+"]"),n=0;n<t.length;n++){if("folder"===(a=t[n]).type){var r=o._createCloudFileListItem(a);$(i).append(r)}}if("open"===o.feature)for(n=0;n<t.length;n++){var a;if("file"===(a=t[n]).type&&("text"===a.mimeType.substring(0,4)||"application/octet-stream"===a.mimeType)){r=o._createCloudFileListItem(a);$(i).append(r)}}},WriteboxChooser._createCloudFileListItem=function(e){var t=this,o=document.createElement("img");"folder"===e.type?$(o).attr("src","/static/image/chooser/folder.png"):$(o).attr("src","/static/image/chooser/file.png");var i=document.createElement("span");e.type;var n=document.createElement("li");return $(n).attr("data-objtype",e.type).attr("data-fileid",e.fileID).attr("data-filestorage",e.storage).attr("data-filename",e.fileName).addClass(e.type).append(o).append(e.fileName).append(i),$(n).click((function(){var e=$(this).attr("data-objtype"),o=$(this).attr("data-filestorage"),i=$(this).attr("data-fileid"),n=$(this).attr("data-filename");if("folder"===e)t._choose(o,i,n);else{var r=t._getCurrentFolder(),a=WriteboxFileInfo.create(o,n,i,r.folderName,r.folderID,t._getCurrentFolderPath());t.selectedCallback(a)}})),n};var searchFolderID=function(e,t){for(var o=-1,i=0;i<e.length;i++)if(e[i].folderID===t){o=i;break}return o};WriteboxChooser._addNavigator=function(e,t){var o=this.currentFolderNavList[this.currentStorage],i=searchFolderID(o,e);return-1===i?o.push({folderID:e,folderName:t}):o.splice(i+1,o.length-(i+1)),o},WriteboxChooser._getCurrentFolderPath=function(){for(var e=this.currentFolderNavList[this.currentStorage],t="",o=1;o<e.length;o++)t+="/"+e[o].folderName;return t},WriteboxChooser._getCurrentFolder=function(){var e=this;if("dropbox"===e.currentStorage)return e._getCurrentFolderPath();var t=e.currentFolderNavList[e.currentStorage];return t[t.length-1]},WriteboxChooser._buildFileNavigatorUI=function(e){var t=this;$(t.dialogID+" .top-navigator").empty();for(var o=0;o<e.length;o++){var i=document.createElement("span");$(i).attr("data-folderid",e[o].folderID).append(e[o].folderName),$(i).click((function(){t._choose(t.currentStorage,$(this).attr("data-folderid"),$(this).text())})),o>0?$(t.dialogID+" .top-navigator").append(" > ").append(i):$(t.dialogID+" .top-navigator").append(" ").append(i)}},WriteboxChooser._updateLocalFileCount=function(){var e=this;WriteboxLocalFileManagement.getFiles((function(t){$(e.dialogID+" .chooser-storagelist[data-storage=local]").text("Local Cache ("+t.length+")")}))},WriteboxChooser._buildLocalFileListUI=function(){var e=this,t=$(this.dialogID+" .chooser-filelist[data-storage=local]");$(t).empty(),WriteboxLocalFileManagement.getFiles((function(o){for(var i=o.length-1;i>=0;i-=1){var n=e._createLocalFileListItem(o[i].wbFileInfo,o[i].contents,i);$(t).append(n)}})),this._updateLocalFileCount()},WriteboxChooser._createLocalFileListItem=function(e,t,o){var i=this,n=document.createElement("li"),r=(document.createElement("div"),document.createElement("div")),a=document.createElement("button"),s=document.createElement("img");$(s).attr("src","/static/image/chooser/file.png");var l="";""!==e.file.name?l=e.file.name:""===(l=t.replace(/^\s+/,"").substr(0,30))&&(l="&lt;No Contents&gt;");return $(r).addClass("file").attr("data-i",o).append(s).append(l),$(a).attr("data-fileid",e.file.id).addClass("button").append("Discard"),$(r).click((function(){loadLocalFile(o),hideDialog()})),$(a).click((function(){WriteboxLocalFileManagement.deleteFile(o),i._updateLocalFileCount(),$(n).slideUp(200,(function(){$(n).remove()}))})),$(n).append(r).append(a),n};var WriteboxFileInfo={create:function(e,t,o,i,n,r){return{storage:{name:e},file:{name:t,id:o,modified:"",edit:!1,mimeType:"text/plain"},parent:{name:i,id:n,path:r}}},createLocalFile:function(){return{storage:{name:"local"},file:{name:"",id:"localid-"+(new Date).getTime()+" "+Math.floor(255*Math.random()+1),modified:"",edit:!1},parent:{name:"",id:"",path:""}}}},WriteboxFileStatus={_currentFileInfo:null,save:function(e){console.log("==WriteboxFileStatus.save() has called=="),this._currentFileInfo=e,$s("wbFileInfo",JSON.stringify(e)),console.log(this._currentFileInfo)},load:function(e){console.log("==WriteboxFileStatus.load() has called=="),console.log(this._currentFileInfo);var t=this;$g("wbFileInfo",(function(o){t._currentFileInfo=o?JSON.parse(o):WriteboxFileInfo.create("","","","","",""),e&&e(t._currentFileInfo),console.log(t._currentFileInfo)}))},get:function(){return console.log("==WriteboxFileStatus.get() has called=="),console.log(this._currentFileInfo),this._currentFileInfo}};WriteboxRecentFileList={},WriteboxRecentFileList.push=function(e,t){this.getAll((function(o){for(var i=0;i<o.length;i+=1){var n=o[i];n.storage.name===e.storage.name&&n.file.id===e.file.id&&o.splice(i,1)}o.push(e),o.length>10&&o.splice(0,1),$s("recentList",JSON.stringify(o),t)}))},WriteboxRecentFileList.deleteAllHistory=function(){$s("recentList",JSON.stringify([]))},WriteboxRecentFileList.getAll=function(e){var t=[];$g("recentList",(function(o){if(o){o=JSON.parse(o);for(var i=0;i<o.length;i++)if(o[i].path){var n=o[i].path.replace("/"+o[i].name,""),r=WriteboxFileInfo.create("dropbox",o[i].name,o[i].path,"","",n);t.push(r)}else t.push(o[i])}e(t)}))},WriteboxLocalFileManagement={},WriteboxLocalFileManagement.saveFile=function(e,t,o){var i=this;this.getFiles((function(n){n.push({wbFileInfo:e,contents:t}),i._saveFileListToLocalStorage(n,(function(e){o(e)}))}))},WriteboxLocalFileManagement.getFiles=function(e){var t=[];$g("pool",(function(o){if(o)for(var i=JSON.parse(o),n=0;n<i.length;n+=1){var r=i[n];if("id"in r){var a=r.path.replace("/"+r.name,""),s=WriteboxFileInfo.create("dropbox",r.name,r.id,"","",a);fileOfCurrentVersion={wbFileInfo:s,contents:r.contents},t.push(fileOfCurrentVersion)}else t.push(r)}e(t)}))},WriteboxLocalFileManagement.getFile=function(e,t){var o=this;this.getFiles((function(i){var n=i[e];i.splice(e,1),o._saveFileListToLocalStorage(i,(function(){})),t(n)}))},WriteboxLocalFileManagement.deleteFile=function(e){var t=this;this.getFiles((function(o){o.splice(e,1),t._saveFileListToLocalStorage(o,(function(){}))}))},WriteboxLocalFileManagement._saveFileListToLocalStorage=function(e,t){try{$s("pool",JSON.stringify(e)),t(!0)}catch(e){showLocalStorageErrorDialog(!0),t(!1)}},WriteboxLocalFileManagement.deleteAllFiles=function(){$s("pool",JSON.stringify([]))};var downloadFile=function(e,t,o){var i=new Blob([t],{type:o+"; charset=utf-8"});window.saveAs(i,e)};function FindControl(){findMode=!1,nextFindPos=0}$.fn.selectRange=function(e,t){return this.each((function(){if(this.setSelectionRange)this.focus(),this.setSelectionRange(e,t);else if(this.createTextRange){var o=this.createTextRange();o.collapse(!0),o.moveEnd("character",t),o.moveStart("character",e),o.select()}}))},$.fn.getCursorPosEnd=function(){var e=0,t=this.get(0);document.selection?(t.focus(),e=document.selection.createRange().text.length):(t.selectionStart||"0"==t.selectionStart)&&(e=t.selectionEnd);return e},FindControl.prototype.init=function(){var e=this;$("#find-query").bind("keyup",(function(t){13===t.keyCode&&(t.shiftKey?e.findPrevious():e.findNext())})),$("#editor").click((function(t){e.findMode&&e.endFindMode()})),$("#editor").keydown((function(t){e.findMode&&(t.preventDefault(),function(e){$("#find-query").focus(),$("#find-query").keypress(e)}(t))})),$("#editor").scroll((function(){e.findMode&&e.syncScrollPos()}))},FindControl.prototype.syncScrollPos=function(){$("#contents-bg").scrollTop($("#editor").scrollTop()),$("#contents-bg").scrollTop()!==$("#editor").scrollTop()&&$("#editor").scrollTop($("#contents-bg").scrollTop())},FindControl.prototype.highlightFindResult=function(e,t){var o,i,n;i=(o=getEditorValue()).slice(0,t),n=o.slice(t+e.length,o.length),$("#contents-bg").html(i.split(e).join('<span class="writebox-highlight">'+e+"</span>")+'<span class="writebox-highlight-focused">'+e+"</span>"+n.split(e).join('<span class="writebox-highlight">'+e+"</span>")),$("span.writebox-highlight, span.writebox-highlight-focused").css("font-family",$("#editor").css("font-family"))},FindControl.prototype.calcHighlightElemPos=function(){var e=$("span.writebox-highlight-focused").offset().top-$("#contents-bg").position().top;return e+=$("#editor").scrollTop(),(e-=10)<0&&(e=0),e},FindControl.prototype.findNext=function(){var e,t=$("#find-query").val(),o=this.nextSearchPos,i=(e=getEditorValue()).indexOf(t,o);-1===i&&(i=e.indexOf(t)),-1!==i&&(this.nextSearchPos=i+t.length,this.highlightFindResult(t,i),$("#editor").scrollTop(this.calcHighlightElemPos()),this.syncScrollPos())},FindControl.prototype.findPrevious=function(){var e,t=$("#find-query").val(),o=this.nextSearchPos;o>t.length&&(o-=t.length);var i=(e=getEditorValue()).slice(0,o).lastIndexOf(t);-1===i&&(i=e.indexOf(t)),-1!==i&&(this.nextSearchPos=i+t.length,this.highlightFindResult(t,i),$("#editor").scrollTop(this.calcHighlightElemPos()),this.syncScrollPos())},FindControl.prototype.startFindMode=function(){this.findMode=!0,this.nextFindPos=$("#editor").getCursorPosEnd(),$("#find-dialog").css("position","absolute").css("right","20px").css("top","39px").show(),$("#find-query").select();var e=this;$("#find-dialog div.dialog-close-button").unbind("click"),$("#find-dialog div.dialog-close-button").bind("click",(function(){e.endFindMode()}))},FindControl.prototype.endFindMode=function(){this.findMode=!1,$("#find-dialog").hide(),$("#contents-bg").hide()},FindControl.prototype.toggleFindMode=function(){this.findMode?this.endFindMode():(this.showEditorHighlightArea(),this.startFindMode())},FindControl.prototype.showEditorHighlightArea=function(){this.layoutEditorHighlightArea(),$("#contents-bg").css("line-height",$("#editor").css("line-height")).css("background-color",$("body").css("background-color")).css("color",$("body").css("background-color")).css("font-family",$("#editor").css("font-family")).css("font-size",$("#editor").css("font-size")).show(),$("#contents-bg").html(getEditorValue().split("\n").join("<br/>")),$("#contents-bg").one("click",(function(){}))},FindControl.prototype.layoutEditorHighlightArea=function(){$("#contents-bg").css("width",$("#editor").width()+parseInt($("#editor").css("padding-right"))).css("height",$("#editor").height()+parseInt($("#editor").css("padding-top"))),$("#contents-bg").css("margin-left",$("#editor").css("margin-left")).css("padding-top",$("#editor").css("padding-top")).css("padding-right",$("#editor").css("padding-right")).css("position","absolute").css("top",$("#editor").position().top).css("left",$("#editor").position().left)};var setEditorValue=function(e){$("#editor").val(e)},getEditorValue=function(){return $("#editor").val()};